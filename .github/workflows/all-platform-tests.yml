name: Trigger all-platform tests

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  trigger-all-platform-tests:

    # Only certain repository members can run it
    if: github.actor == 'ncreated' || github.actor == 'buranmert' || github.actor == 'nachoBonafonte'

    runs-on: ubuntu-latest
    steps:
      - name: Look for a keyword triggering Bitrise build
        id: check-keyword-trigger
        env:
          GITHUB_TOKEN: ${{ secrets.DUMMY_CONSTRAINED_GH_TOKEN }}
        uses: khan/pull-request-comment-trigger@014b821
        with:
          trigger: '@test-all-platforms'
          reaction: rocket
      - name: Trigger Bitrise build
        if: steps.check-keyword-trigger.outputs.triggered == 'true'
        env:
          BITRISE_APP_SLUG: ${{ secrets.DUMMY_BITRISE_APP_SLUG }}
          BITRISE_TOKEN: ${{ secrets.DUMMY_BITRISE_TOKEN }}
          CURRENT_BRANCH: ${{ github.ref }}
          CURRENT_PR_SOURCE_BRANCH: ${{ github.head_ref }}
        shell: bash
        run: |
          if [[ -z "${CURRENT_PR_SOURCE_BRANCH}" ]]; then
            # when running due to a push to existing Pull Request
            CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          else
            # when running due to opening a Pull Request
            CURRENT_BRANCH="${CURRENT_PR_SOURCE_BRANCH}"
          fi

          echo "Calling Bitrise API to run build for branch: $CURRENT_BRANCH"

          curl -X POST "https://api.bitrise.io/v0.1/apps/${BITRISE_APP_SLUG}/builds" \
               -H "accept: application/json" \
               -H "Authorization: ${BITRISE_TOKEN}" \
               -H "Content-Type: application/json" \
               -d "{ \"build_params\": { \"branch\": \"${CURRENT_BRANCH}\", \"workflow_id\": \"trigger_all_platform_tests\" }, \"hook_info\": { \"type\": \"bitrise\" }}"
